<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S37T17U222">change_points</span>] = ICSS_step_1_and_2(<span class="var type1" id="S38T1U225">data</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line"><span class="comment">% ICSS_STEP_1_AND_2 Perform the first two steps of the ICSS alg, recursive</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line"><span class="comment">%   The first two steps find all the potential change points. Due to its</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line"><span class="comment">%   recursive nature, the masking effect of changes is minimized.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line">    <span class="mxinfo" id="T17:U3"><span class="var type1" id="S37T17U228">change_points</span> = <span class="mxinfo" id="T18:U5">[]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line">    <span class="keyword">if</span> length(<span class="var type1" id="S38T1U236">data</span>) &lt; 0</span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line">        <span class="keyword">return</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line">    <span class="comment">% Step 1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line">    <span class="mxinfo" id="T1:U7"><span class="var type1" id="S40T1U241">Dk</span> = <span class="mxinfo" id="T1:U9"><span class="fcn" id="F4N2:B243">CenteredCusumValues</span>(<span class="var type1" id="S38T1U244">data</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line">    <span class="mxinfo" id="T5:U11">[<span class="var type1" id="S42T5U248">exceeds</span>, <span class="var type1" id="S43T2U249">position_step1</span>] = <span class="fcn" id="F68N5:B251">check_critical_value</span>(<span class="var type1" id="S40T1U252">Dk</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S42T5U255">exceeds</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line">        <span class="comment">% There is a change point</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line">        <span class="comment">% Step 2a</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line">        <span class="comment">% -------</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line">        <span class="mxinfo" id="T2:U16"><span class="var type1" id="S45T2U258">position</span> = <span class="var type1" id="S43T2U259">position_step1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line">        <span class="keyword">while</span> <span class="var type1" id="S42T5U261">exceeds</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line">            <span class="comment">% Scan first part</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line">            <span class="mxinfo" id="T2:U20"><span class="var type1" id="S46T2U264">t2</span> = <span class="var type1" id="S45T2U265">position</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line">            <span class="mxinfo" id="T14:U23"><span class="var type1" id="S47T14U268">Dk_step2a</span> = <span class="mxinfo" id="T14:U25"><span class="fcn" id="F88N2:B270">CenteredCusumValues</span>(<span class="mxinfo" id="T14:U26"><span class="var type1" id="S38T1U272">data</span>(<span class="mxinfo" id="T2:U28">1</span>:<span class="var type1" id="S46T2U275">t2</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line">            <span class="mxinfo" id="T5:U30">[<span class="var type1" id="S42T5U279">exceeds</span>, <span class="var type1" id="S45T2U280">position</span>] = <span class="fcn" id="F141N5:B282">check_critical_value</span>(<span class="var type1" id="S47T14U283">Dk_step2a</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line">        <span class="mxinfo" id="T2:U34"><span class="var type1" id="S48T2U286">k_first</span> = <span class="var type1" id="S46T2U287">t2</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line">        <span class="comment">% Step 2b</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line">        <span class="comment">% -------</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line">        <span class="mxinfo" id="T2:U37"><span class="var type1" id="S45T2U290">position</span> = <span class="mxinfo" id="T2:U39"><span class="var type1" id="S43T2U292">position_step1</span> + <span class="mxinfo" id="T2:U41">1</span></span></span>;        </span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line">        <span class="mxinfo" id="T5:U42"><span class="var type1" id="S42T5U296">exceeds</span> = <span class="mxinfo" id="T5:U44">true</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line">        <span class="keyword">while</span> <span class="var type1" id="S42T5U300">exceeds</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line">            <span class="comment">% Scan last part</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line">            <span class="mxinfo" id="T2:U46"><span class="var type1" id="S50T2U303">t1</span> = <span class="var type1" id="S45T2U304">position</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line">            <span class="mxinfo" id="T14:U49"><span class="var type1" id="S51T14U307">Dk_step2b</span> = <span class="mxinfo" id="T14:U51"><span class="fcn" id="F88N2:B309">CenteredCusumValues</span>(<span class="mxinfo" id="T14:U52"><span class="var type1" id="S38T1U311">data</span>(<span class="var type1" id="S50T2U313">t1</span>:<span class="mxinfo" id="T2:U55">end</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line">            <span class="mxinfo" id="T5:U56">[<span class="var type1" id="S42T5U319">exceeds</span>, <span class="var type1" id="S53T2U320">position2</span>] = <span class="fcn" id="F141N5:B322">check_critical_value</span>(<span class="var type1" id="S51T14U323">Dk_step2b</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line">            <span class="mxinfo" id="T2:U60"><span class="var type1" id="S45T2U326">position</span> = <span class="mxinfo" id="T2:U62"><span class="var type1" id="S53T2U328">position2</span> + <span class="var type1" id="S45T2U329">position</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line">        <span class="mxinfo" id="T2:U65"><span class="var type1" id="S54T2U332">k_last</span> = <span class="mxinfo" id="T2:U67"><span class="var type1" id="S50T2U334">t1</span> - <span class="mxinfo" id="T2:U69">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line">        <span class="comment">% Step 2c</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line">        <span class="comment">% -------</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo" id="T5:U70"><span class="var type1" id="S48T2U339">k_first</span> == <span class="var type1" id="S54T2U340">k_last</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line">            <span class="comment">% Just one change-point, stop here</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line">            <span class="mxinfo" id="T17:U73"><span class="var type1" id="S37T17U343">change_points</span> = <span class="var type1" id="S48T2U344">k_first</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line">        <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line">            <span class="comment">% Multiple change points; repeat for the section between them</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line">            <span class="var type0" id="S55T0U348">deep</span> = <span class="message error" id="M13F2C">ICSS(<span class="mxinfo" id="T14:U76"><span class="var type1" id="S38T1U352">data</span>(<span class="var type1" id="S48T2U354">k_first</span>:<span class="var type1" id="S54T2U355">k_last</span>)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line">            <span class="comment">% Add the first position to all the returned change points of</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line">            <span class="comment">% the recursive, to get the correct offset</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line">            <span class="var type2" id="S37T0U358">change_points</span> = [<span class="var type1" id="S48T2U361">k_first</span>, <span class="var type0" id="S55T0U363"><span class="message error" id="M14F2C">deep</span></span> + <span class="var type2" id="S48T0U364">k_first</span>, <span class="var type2" id="S54T0U365">k_last</span>];</span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line"></span></span>
</pre>
